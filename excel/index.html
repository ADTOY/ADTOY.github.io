<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç½‘é¡µç‰ˆæŠ¥ä»·å•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Luckysheet æ ·å¼ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/css/pluginsCss.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/css/luckysheet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/assets/iconfont/iconfont.css" />
  <style>
    body,html{margin:0;padding:0;height:100%;width:100%;}
    #toolbar{padding:10px;background:#f0f0f0;text-align:center;}
    #luckysheet{width:100%;height:calc(100% - 60px);}
    button{margin:5px;padding:6px 12px;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
           background:#333;color:#fff;padding:8px 16px;border-radius:4px;display:none;}
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <button onclick="saveSheet()">ğŸ’¾ ä¿å­˜</button>
    <button onclick="exportExcel()">ğŸ“¤ å¯¼å‡ºExcel</button>
    <button onclick="exportImage()">ğŸ–¼ å¯¼å‡ºå›¾ç‰‡</button>
    <button onclick="clearSheet()">ğŸ—‘ æ¸…ç©º</button>
  </div>
  <div id="luckysheet"></div>
  <div class="toast" id="toast"></div>

  <!-- JS ä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/luckysheet.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>

  <script>
    const STORAGE_KEY = "quoteSheetData";

    // âœ… ä½ çš„ JSONBin é…ç½®ï¼ˆå·²æ›¿æ¢ï¼‰
    const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68d3f5e543b1c97be94e4edc"; 
    const JSONBIN_KEY = "$2a$10$xBzgjtZBWzlqxR.25zIpUOfe8ljxfv2wIaNCFuuONUipmtj5gStGu";

    // âœ… Toast æç¤º
    function showToast(msg){
      const t=document.getElementById("toast");
      t.innerText=msg; t.style.display="block";
      setTimeout(()=>{t.style.display="none";},2000);
    }

    // âœ… å½»åº•é”€æ¯ Luckysheet
    function resetLuckysheetDOM(){
      try{luckysheet.destroy();}catch(e){}
      document.getElementById("luckysheet").innerHTML="";
    }

    // âœ… ä¿®å¤è¡Œåˆ—æ•°
    function fixSheetSize(sheet){
      let maxR=0,maxC=0;
      if(sheet.celldata){
        sheet.celldata.forEach(cell=>{
          if(cell.r>maxR) maxR=cell.r;
          if(cell.c>maxC) maxC=cell.c;
        });
      }
      sheet.row=Math.max(sheet.row||0,maxR+20);
      sheet.column=Math.max(sheet.column||0,maxC+10);
      if(!sheet.config) sheet.config={};
      return sheet;
    }

    // âœ… è¿‡æ»¤éæ³•å•å…ƒæ ¼
    function sanitizeCelldata(sheet){
      if(!sheet.celldata) return sheet;
      sheet.celldata=sheet.celldata.filter(cell=>{
        return cell && typeof cell.r==="number" && typeof cell.c==="number" && cell.v;
      });
      return sheet;
    }

    // âœ… åˆå§‹åŒ– Luckysheet
    function initLuckysheet(data){
      resetLuckysheetDOM();
      try{
        luckysheet.create({
          container:'luckysheet',
          showinfobar:false,
          lang:'zh',
          data:data || [{
            name:"æŠ¥ä»·å•", index:0, status:1, order:0,
            row:40, column:12, celldata:[], config:{}
          }],
          showsheetbar:true,
          showtoolbar:true,
          forceCalculation:false
        });
      }catch(err){
        console.error("æ¸²æŸ“é”™è¯¯:",err);
        showToast("âš ï¸ è¡¨æ ¼æ¸²æŸ“å¤±è´¥ï¼Œå·²æ¢å¤ä¸ºç©ºè¡¨");
        resetLuckysheetDOM();
        luckysheet.create({container:'luckysheet',data:[{name:"ç©ºè¡¨",index:0,row:40,column:12,celldata:[]} ]});
      }
    }

    // âœ… å¯¼å…¥æ–‡ä»¶
    document.getElementById("fileInput").addEventListener("change",function(e){
      const file=e.target.files[0];
      if(!file) return;
      LuckyExcel.transformExcelToLucky(file,(exportJson)=>{
        if(!exportJson.sheets || exportJson.sheets.length===0){
          showToast("âš ï¸ æ— æ³•è§£ææ–‡ä»¶");
          return;
        }
        let sheets=exportJson.sheets.map(s=>sanitizeCelldata(fixSheetSize(s)));
        localStorage.setItem(STORAGE_KEY,JSON.stringify(sheets));
        saveToCloud(sheets);
        initLuckysheet(sheets);
        showToast("âœ… å¯¼å…¥æˆåŠŸ");
      });
    });

    // âœ… ä¿å­˜ï¼ˆæœ¬åœ° + äº‘ç«¯ï¼‰
    async function saveSheet(){
      const data=luckysheet.getAllSheets();
      localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
      await saveToCloud(data);
      // åŒæ—¶ä¸‹è½½ Excel æ–‡ä»¶
      luckysheet.exportExcel().then(excelFile=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(excelFile);
        a.download="æŠ¥ä»·å•.xlsx";
        a.click();
      });
      showToast("âœ… å·²ä¿å­˜ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰");
    }

    // âœ… ä¿å­˜åˆ°äº‘ç«¯
    async function saveToCloud(data){
      try{
        await fetch(JSONBIN_URL, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": JSONBIN_KEY
          },
          body: JSON.stringify(data)
        });
      }catch(e){
        console.error("äº‘ç«¯ä¿å­˜å¤±è´¥:",e);
        showToast("âš ï¸ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä»…ä¿å­˜æœ¬åœ°");
      }
    }

    // âœ… ä»äº‘ç«¯åŠ è½½
    async function loadFromCloud(){
      try{
        const res = await fetch(JSONBIN_URL+"/latest", {
          headers: {"X-Master-Key": JSONBIN_KEY}
        });
        const json = await res.json();
        if(json.record){
          initLuckysheet(json.record);
          showToast("â˜ï¸ å·²åŠ è½½äº‘ç«¯æ•°æ®");
          return true;
        }
      }catch(e){
        console.warn("äº‘ç«¯åŠ è½½å¤±è´¥:",e);
      }
      return false;
    }

    // âœ… å¯¼å‡º Excel
    function exportExcel(){
      luckysheet.exportExcel().then(excelFile=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(excelFile);
        a.download="æŠ¥ä»·å•.xlsx";
        a.click();
      });
      showToast("ğŸ“¤ å·²å¯¼å‡ºExcel");
    }

    // âœ… å¯¼å‡ºå›¾ç‰‡
    function exportImage(){
      luckysheet.toJson().then(blob=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="æŠ¥ä»·å•.png";
        a.click();
      });
      showToast("ğŸ–¼ å·²å¯¼å‡ºå›¾ç‰‡");
    }

    // âœ… æ¸…ç©º
    function clearSheet(){
      if(confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºå½“å‰è¡¨æ ¼å—ï¼Ÿ")){
        localStorage.removeItem(STORAGE_KEY);
        initLuckysheet(null);
        showToast("ğŸ—‘ å·²æ¸…ç©º");
      }
    }

    // âœ… é¡µé¢åŠ è½½æ—¶ï¼šä¼˜å…ˆäº‘ç«¯ â†’ å…¶æ¬¡æœ¬åœ° â†’ æœ€åç©ºè¡¨
    window.onload=async function(){
      const ok = await loadFromCloud();
      if(!ok){
        let saved=localStorage.getItem(STORAGE_KEY);
        if(saved){
          try{
            initLuckysheet(JSON.parse(saved));
            showToast("ğŸ“‚ å·²åŠ è½½æœ¬åœ°ç¼“å­˜");
          }catch(e){
            console.warn("ç¼“å­˜æŸåï¼Œæ¢å¤ç©ºè¡¨");
            initLuckysheet(null);
          }
        }else{
          initLuckysheet(null);
        }
      }
    }
  </script>
</body>
</html>
