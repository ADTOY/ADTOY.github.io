<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ç½‘é¡µç‰ˆæŠ¥ä»·è¡¨ï¼ˆSheetJS + Luckysheetï¼‰</title>

  <!-- Luckysheet æ ·å¼ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/css/pluginsCss.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/css/luckysheet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/assets/iconfont/iconfont.css" />

  <!-- Luckysheet JS -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/luckysheet.umd.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; }
    .toolbar {
      display:flex; flex-wrap:wrap; gap:8px;
      padding:8px; background:#f5f5f5;
      align-items:center; justify-content:center;
    }
    .toolbar input, .toolbar button {
      min-width:90px; padding:8px; font-size:14px;
    }
    #luckysheet { width:100%; height:calc(100vh - 64px); }
    .toast {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8); color:#fff;
      padding:10px 16px; border-radius:6px; display:none; z-index:9999;
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <input type="file" id="uploadExcel" accept=".xlsx,.xls" />
    <button id="btnSave">ğŸ’¾ ä¿å­˜Excel</button>
    <button id="btnExportImage">ğŸ–¼ å¯¼å‡ºå›¾ç‰‡</button>
    <button id="btnClear">ğŸ—‘ æ¸…ç©º</button>
  </div>

  <div id="luckysheet"></div>
  <div id="toast" class="toast"></div>

<script>
/* ========== é…ç½® ========== */
const STORAGE_KEY = "my_luckysheet_data_v1"; // æœ¬åœ°ç¼“å­˜é”®å

/* ========== Toast ========== */
function showToast(msg, ms=1800){
  const t = document.getElementById("toast");
  t.innerText = msg; t.style.display = "block";
  clearTimeout(t._timer);
  t._timer = setTimeout(()=> t.style.display = "none", ms);
}

/* ========== åˆå§‹åŒ– Luckysheet ========== */
function initLuckysheet(data){
  try { luckysheet.destroy(); } catch(e){}
  luckysheet.create({
    container: 'luckysheet',
    showinfobar: false,
    lang: 'zh',
    data: data || [{
      name: "Sheet1",
      index: 0,
      status: 1,
      order: 0,
      row: 50,
      column: 20,
      celldata: [],
      config: {}
    }],
    showsheetbar: true,
    showtoolbar: true
  });
}

/* è¯»å–æœ¬åœ°ç¼“å­˜ä¼˜å…ˆåŠ è½½ */
window.addEventListener("load", ()=>{
  let saved = null;
  try { saved = localStorage.getItem(STORAGE_KEY); } catch(e){}
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      initLuckysheet(parsed);
      showToast("å·²åŠ è½½æœ¬åœ°ä¿å­˜çš„æ•°æ®");
      return;
    } catch(e){
      console.warn("æœ¬åœ°æ•°æ®è§£æå¤±è´¥ï¼Œåˆå§‹åŒ–ç©ºè¡¨", e);
    }
  }
  initLuckysheet(null);
});

/* ========== è¾…åŠ©ï¼šSheetJS -> Luckysheet è½¬æ¢ ========== */
/*
  æˆ‘ä»¬æŠŠæ¯ä¸ª worksheet çš„å•å…ƒæ ¼é€ä¸ªè½¬æ¢æˆ Luckysheet çš„ celldata ç»“æ„ã€‚
  ä¹ŸæŠŠåˆå¹¶ä¿¡æ¯ (!merges) è½¬æˆ Luckysheet çš„ mergeï¼ˆluckysheet ä½¿ç”¨çš„æ˜¯ { r, c, rs, cs } é£æ ¼ï¼‰ã€‚
*/
function sheet_to_luckysheet(ws, sheetName) {
  const celldata = [];
  const merges = [];
  const range = XLSX.utils.decode_range(ws['!ref'] || "A1:A1");

  // éå†æ‰€æœ‰å•å…ƒæ ¼ï¼šSheetJS æŠŠå•å…ƒæ ¼æ”¾åœ¨ ws[address]
  for (let R = range.s.r; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      const cell = ws[addr];
      if (!cell) continue;
      // cell.v åŸå§‹å€¼ï¼Œcell.w æ ¼å¼åŒ–æ–‡æœ¬ï¼Œcell.f å…¬å¼ (string)
      const displayText = (cell.w !== undefined) ? String(cell.w) : (cell.v !== undefined ? String(cell.v) : "");
      const rawVal = cell.v;
      const luckCell = {
        r: R,
        c: C,
        v: { m: displayText, v: rawVal }
      };
      // å¦‚æœæœ‰å…¬å¼ï¼Œå°è¯•ä¿ç•™
      if (cell.f) {
        // luckysheet çš„ celldata æœ‰æ—¶æœŸæœ› f åœ¨é¡¶å±‚æˆ– v.fï¼›æˆ‘ä»¬æŠŠ formula å­˜åœ¨ 'f' å­—æ®µï¼ˆå…¼å®¹å¯¼å‡ºï¼‰
        luckCell.f = cell.f;
      }
      celldata.push(luckCell);
    }
  }

  // åˆå¹¶å•å…ƒæ ¼è½¬æ¢
  if (Array.isArray(ws['!merges'])) {
    ws['!merges'].forEach(m => {
      // m = {s:{r,c}, e:{r,c}}
      merges.push({
        r: m.s.r,
        c: m.s.c,
        rs: m.e.r - m.s.r + 1,
        cs: m.e.c - m.s.c + 1
      });
    });
  }

  // è¡Œåˆ—å°ºå¯¸ï¼ˆç»™ Luckysheet ä¸€ä¸ªåˆç†çš„åˆå§‹å¤§å°ï¼‰
  const rowCount = range.e.r + 1;
  const colCount = range.e.c + 1;

  return {
    name: sheetName || "Sheet1",
    index: 0,
    status: 1,
    order: 0,
    row: Math.max(rowCount, 20),
    column: Math.max(colCount, 10),
    celldata: celldata,
    config: { merge: merges.length? merges: undefined, columnlen: {}, rowlen: {} },
    // å¦‚æœä¸ä¸ºç©ºæŠŠ merge æ”¾åˆ° mergesï¼ˆluckysheet æ”¯æŒä¸åŒå­—æ®µåï¼Œå…¼å®¹ï¼‰
    // æ³¨æ„ï¼šLuckysheet æœ‰å¤šç§ç‰ˆæœ¬ï¼Œæä¾› merge æ”¾å¥½è®©æ¸²æŸ“ä½¿ç”¨
    // è¿˜å¯ä»¥è®¾ç½® configç­‰æ›´å¤šå­—æ®µ
  };
}

/* ========== å¯¼å…¥ï¼šé€šè¿‡ SheetJS è§£æå¹¶è¦†ç›– ========== */
document.getElementById("uploadExcel").addEventListener("change", async function(e){
  const file = e.target.files[0];
  if (!file) return;
  // å¼ºåˆ¶ .xlsx æ›´å¯é 
  // confirmation
  if (!confirm("âš ï¸ ç¡®è®¤è¦†ç›–å½“å‰è¡¨æ ¼ï¼Ÿï¼ˆä¼šæ¸…é™¤å½“å‰æœ¬åœ°ç¼“å­˜ï¼‰")) {
    e.target.value = "";
    return;
  }

  try {
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, {type: "array", cellDates:true, cellNF:true, cellStyles:false});
    console.log("SheetJS workbook:", workbook);
    const luckysheets = [];

    workbook.SheetNames.forEach((sheetName, idx) => {
      const ws = workbook.Sheets[sheetName];
      const sheet = sheet_to_luckysheet(ws, sheetName);
      sheet.index = idx;
      luckysheets.push(sheet);
    });

    // è¦†ç›–ï¼šæ¸…ç¼“å­˜ + é”€æ¯å®ä¾‹ + åˆ›å»ºæ–°è¡¨
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    try { luckysheet.destroy(); } catch(e){}
    initLuckysheet(luckysheets);

    // ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ‰‹åŠ¨ä¿å­˜çš„è¦æ±‚æ˜¯â€œæ‰‹åŠ¨ä¿å­˜â€ â€” è¿™é‡Œä»…åšç¼“å­˜ä»¥ä¾¿ä¸‹æ¬¡è‡ªåŠ¨åŠ è½½ï¼‰
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(luckysheets)); } catch(e){ console.warn("localStorageå†™å…¥å¤±è´¥", e); }

    showToast("å¯¼å…¥å¹¶è¦†ç›–å®Œæˆ âœ…");
    e.target.value = "";
  } catch (err) {
    console.error("å¯¼å…¥å¤±è´¥ï¼š", err);
    alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æ ‡å‡† .xlsxï¼ˆåœ¨ WPS é‡Œå¦å­˜ä¸º Excel å·¥ä½œç°¿ .xlsxï¼‰ã€‚æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚");
  }
});

/* ========== å¯¼å‡ºï¼šLuckysheet -> SheetJS Workbookï¼Œç„¶åä¸‹è½½ ========== */
/* è¿™é‡Œæˆ‘ä»¬æŠŠ luckysheet.getAllSheets() ä¸­çš„ celldata è½¬æ¢å› worksheet cellsï¼ˆå«å…¬å¼fï¼‰ */
function luckysheet_to_workbook(sheets) {
  const wb = XLSX.utils.book_new();

  sheets.forEach((sheet) => {
    const ws = {};
    let maxR = 0, maxC = 0;

    if (Array.isArray(sheet.celldata)) {
      sheet.celldata.forEach(cell => {
        const r = cell.r, c = cell.c;
        maxR = Math.max(maxR, r);
        maxC = Math.max(maxC, c);

        const addr = XLSX.utils.encode_cell({r:r, c:c});
        const vobj = (cell.v && cell.v.v !== undefined) ? cell.v.v : (cell.v ? cell.v : "");
        // è®¾ç½® value
        ws[addr] = { v: vobj };

        // å¦‚æœæœ‰æ ¼å¼åŒ–æ–‡æœ¬ m, ä¹Ÿæ”¾ wï¼ˆè¿™æ˜¯å¯é€‰ï¼‰
        if (cell.v && cell.v.m !== undefined) ws[addr].w = String(cell.v.m);

        // å¦‚æœ luckysheet çš„ celldata æœ‰ fï¼ˆå…¬å¼ï¼‰ï¼Œè®¾ç½® .f
        if (cell.f) {
          ws[addr].f = cell.f;
        }
      });
    }

    // åˆå¹¶ï¼ˆå¦‚æœæœ‰ï¼‰
    const merges = [];
    // luckysheet ä¸­æœ‰æ—¶æŠŠ merges å­˜åœ¨ sheet.config.merge æˆ– sheet.merge
    if (sheet.config && sheet.config.merge) {
      sheet.config.merge.forEach(m => {
        merges.push({s:{r:m.r,c:m.c}, e:{r:m.r + (m.rs-1), c:m.c + (m.cs-1)}});
      });
    } else if (sheet.merge && Array.isArray(sheet.merge)) {
      sheet.merge.forEach(m => {
        merges.push({s:{r:m.r,c:m.c}, e:{r:m.r + (m.rs-1), c:m.c + (m.cs-1)}});
      });
    }
    if (merges.length) ws['!merges'] = merges;

    // è®¾ç½®èŒƒå›´
    const range = {s:{r:0,c:0}, e:{r: Math.max(maxR, sheet.row?sheet.row-1:0), c: Math.max(maxC, sheet.column?sheet.column-1:0)}};
    ws['!ref'] = XLSX.utils.encode_range(range);

    XLSX.utils.book_append_sheet(wb, ws, sheet.name || "Sheet");
  });

  return wb;
}

document.getElementById("btnSave").addEventListener("click", function(){
  try {
    const sheets = luckysheet.getAllSheets();
    // ä¿å­˜åˆ° localStorageï¼ˆä½ è¦çš„æ˜¯æ‰‹åŠ¨ä¿å­˜ï¼‰
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(sheets)); } catch(e){ console.warn("localStorageå†™å…¥å¤±è´¥", e); }

    // å¯¼å‡º .xlsx
    const wb = luckysheet_to_workbook(sheets);
    XLSX.writeFile(wb, "æŠ¥ä»·è¡¨-å¯¼å‡º.xlsx");

    showToast("ä¿å­˜æˆåŠŸ âœ…ï¼ˆå·²ä¸‹è½½ Excelï¼Œå¹¶ç¼“å­˜è‡³æœ¬åœ°ï¼‰");
  } catch (e) {
    console.error("ä¿å­˜å¤±è´¥", e);
    alert("ä¿å­˜å¤±è´¥ï¼Œæ§åˆ¶å°æŸ¥çœ‹é”™è¯¯");
  }
});

/* ========== å¯¼å‡ºå›¾ç‰‡ ========== */
document.getElementById("btnExportImage").addEventListener("click", function(){
  const container = document.getElementById("luckysheet");
  // html2canvas æˆªå›¾å¯èƒ½æˆªåˆ°è¶…å®½ï¼Œscale æå‡å›¾ç‰‡è´¨é‡
  html2canvas(container, { scale: 2 }).then(canvas=>{
    const link = document.createElement("a");
    link.download = "æŠ¥ä»·è¡¨.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
    showToast("å¯¼å‡ºå›¾ç‰‡æˆåŠŸ âœ…");
  }).catch(err=>{
    console.error("å¯¼å‡ºå›¾ç‰‡å¤±è´¥", err);
    alert("å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼ˆæ§åˆ¶å°æœ‰è¯¦ç»†ä¿¡æ¯ï¼‰");
  });
});

/* ========== æ¸…ç©º ========== */
document.getElementById("btnClear").addEventListener("click", function(){
  if (!confirm("ç¡®è®¤æ¸…ç©ºæœ¬åœ°æ•°æ®å¹¶æ¢å¤ç©ºè¡¨ï¼Ÿ")) return;
  try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
  initLuckysheet(null);
  showToast("å·²æ¸…ç©ºæœ¬åœ°æ•°æ® ğŸ—‘");
});
</script>

</body>
</html>
