<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>æŠ¥ä»·è¡¨ï¼ˆç½‘é¡µç‰ˆï¼Œæ”¯æŒå¯¼å…¥/ä¿å­˜/å¯¼å‡º/æ ·å¼ï¼‰</title>

  <!-- Luckysheet æ ·å¼ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/css/pluginsCss.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/css/luckysheet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/assets/iconfont/iconfont.css" />

  <!-- Luckysheet æ ¸å¿ƒ -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/luckysheet.umd.js"></script>

  <!-- LuckyExcelï¼ˆå°è¯•ä» ruilisi çš„ UMD CDNï¼‰-->
  <script src="https://cdn.jsdelivr.net/gh/ruilisi/luckyexcel/dist/luckyexcel.umd.js"></script>
  <!-- å…¼å®¹æ€§å¤‡ä»½ï¼ˆoy-paddy forkï¼‰-->
  <script>
    // å¦‚æœä¸Šé¢çš„æ²¡æœ‰åŠ è½½ global LuckyExcelï¼Œä¼šå°è¯•å¤‡ç”¨åœ°å€ï¼ˆåŠ¨æ€åŠ è½½ï¼‰
    (function(){
      if (typeof window.LuckyExcel === "undefined") {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/gh/oy-paddy/luckysheet_import_export/dist/luckyexcel.js";
        s.onload = ()=>console.log("å¤‡ç”¨ LuckyExcel åŠ è½½å®Œæ¯•");
        s.onerror = ()=>console.log("å¤‡ç”¨ LuckyExcel åŠ è½½å¤±è´¥ï¼ˆå°†ä½¿ç”¨ SheetJS å›é€€è§£æï¼‰");
        document.head.appendChild(s);
      }
    })();
  </script>

  <!-- SheetJSï¼ˆå¤‡é€‰è§£æ/å¯¼å‡ºï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- html2canvasï¼ˆå›¾ç‰‡å›é€€ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .toolbar {
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px; background:#f5f7fa; align-items:center; justify-content:center;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
      position: sticky; top: 0; z-index: 999;
    }
    .toolbar input[type=file] { display:none; }
    .toolbar .btn { min-width:88px; padding:8px 12px; border-radius:6px; border:1px solid #dcdcdc; background:#fff; cursor:pointer; }
    .toolbar .primary { background:#0366d6; color:#fff; border-color:#0366d6; }
    #luckysheet { width:100%; height: calc(100vh - 64px); }
    #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:rgba(0,0,0,0.78); color:#fff; padding:10px 14px; border-radius:6px; display:none; z-index:2000; }
    @media (max-width:520px){
      .toolbar { padding:8px; }
      .toolbar .btn { min-width:72px; padding:7px 8px; font-size:13px; }
    }
  </style>
</head>
<body>

  <div class="toolbar" role="toolbar" aria-label="æŠ¥ä»·è¡¨å·¥å…·æ ">
    <label class="btn" id="btnImportLabel"><input id="fileInput" type="file" accept=".xlsx,.xls" />ğŸ“‚ å¯¼å…¥Excel</label>
    <button class="btn primary" id="btnSave">ğŸ’¾ ä¿å­˜ï¼ˆä¸‹è½½å¹¶ç¼“å­˜ï¼‰</button>
    <button class="btn" id="btnExportImage">ğŸ–¼ å¯¼å‡ºå›¾ç‰‡</button>
    <button class="btn" id="btnReset">â™»ï¸ æ¢å¤ç©ºè¡¨</button>
    <span id="status" style="margin-left:10px;color:#666;font-size:13px;"></span>
  </div>

  <div id="luckysheet" aria-live="polite"></div>
  <div id="toast" role="status" aria-atomic="true"></div>

<script>
/* ================= CONFIG ================= */
const STORAGE_KEY = "web_quote_luckysheet_v2";

/* ================ UTIL ================ */
function showToast(msg, ms=2000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._timer);
  t._timer = setTimeout(()=> t.style.display = 'none', ms);
}
function setStatus(msg){ document.getElementById('status').textContent = msg; }

/* ================ LUCKYSHEET INIT with SAFE FALLBACK ================ */
function safeInitLuckysheet(data){
  // try destroy first (may throw)
  try { luckysheet.destroy(); } catch(e){ /* ignore */ }

  // Wrap create in try/catch and fallback to empty table if fails
  try {
    luckysheet.create({
      container: 'luckysheet',
      showinfobar: false,
      lang: 'zh',
      data: data || [{
        name: "æŠ¥ä»·è¡¨",
        index: 0, status: 1, order: 0,
        row: 40, column: 12,
        celldata: [], config: {}
      }],
      showsheetbar: true,
      showtoolbar: true,
      forceCalculation: false // avoid heavy re-calculation on large import
    });
    setStatus('å°±ç»ª');
  } catch (err){
    console.error('Luckysheet æ¸²æŸ“å¼‚å¸¸ï¼š', err);
    // é¿å…å¡æ­»ï¼šæ¸…æœ¬åœ°ç¼“å­˜å¹¶å›é€€ä¸€ä¸ªå¹²å‡€çš„ç©ºè¡¨
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    try { luckysheet.destroy(); } catch(e){}
    luckysheet.create({
      container: 'luckysheet',
      showinfobar: false, lang:'zh',
      data:[{
        name:'æŠ¥ä»·è¡¨', index:0, status:1, order:0, row:40, column:12, celldata:[], config:{}
      }],
      showsheetbar:true, showtoolbar:true, forceCalculation:false
    });
    showToast('è¡¨æ ¼åŠ è½½å¤±è´¥ï¼Œå·²æ¢å¤ç©ºè¡¨');
    setStatus('å·²æ¢å¤ç©ºè¡¨');
  }
}

/* load saved data from localStorage safely */
(function loadLocal(){
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      safeInitLuckysheet(parsed);
      showToast('å·²åŠ è½½ä¸Šæ¬¡ä¿å­˜æ•°æ®');
    } else {
      safeInitLuckysheet(null);
    }
  } catch(e) {
    console.warn('æœ¬åœ°åŠ è½½å¤±è´¥ï¼Œåˆå§‹åŒ–ç©ºè¡¨', e);
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    safeInitLuckysheet(null);
  }
})();

/* ================ IMPORT LOGIC (LuckyExcelä¼˜å…ˆï¼Œå›é€€SheetJS) ================ */

/* helper: convert SheetJS worksheet -> luckysheet sheet (with styles if present) */
function sheetjs_to_luckysheet(ws, sheetName){
  const celldata = [];
  const merges = [];
  const range = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : {s:{r:0,c:0}, e:{r:0,c:0}};
  let maxR = 0, maxC = 0;

  // iterate cells
  for (let R = range.s.r; R <= range.e.r; ++R){
    for (let C = range.s.c; C <= range.e.c; ++C){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      const cell = ws[addr];
      if (!cell) continue;
      maxR = Math.max(maxR, R);
      maxC = Math.max(maxC, C);

      // value & display text
      const vRaw = cell.v;
      const disp = (cell.w !== undefined) ? String(cell.w) : (vRaw !== undefined ? String(vRaw) : "");
      const v = { v: vRaw, m: disp };

      // formula
      if (cell.f) { v.f = cell.f; }

      // styles (if available)
      if (cell.s){
        if (cell.s.font){
          if (cell.s.font.bold) v.bl = 1;
          if (cell.s.font.italic) v.it = 1;
          if (cell.s.font.color && cell.s.font.color.rgb){
            // rgb sometimes like "FF000000" or "FFFF0000"
            let rgb = cell.s.font.color.rgb;
            if (rgb.length === 8 && rgb.startsWith('FF')) rgb = rgb.slice(2);
            v.fc = '#'+rgb;
          }
        }
        if (cell.s.fill && cell.s.fill.fgColor && cell.s.fill.fgColor.rgb){
          let rgb = cell.s.fill.fgColor.rgb;
          if (rgb.length === 8 && rgb.startsWith('FF')) rgb = rgb.slice(2);
          v.bg = '#'+rgb;
        }
        if (cell.s.alignment){
          const hor = cell.s.alignment.horizontal;
          v.ht = (hor==='center')?1:((hor==='right')?2:0);
          const ver = cell.s.alignment.vertical;
          v.vt = (ver==='center')?1:((ver==='bottom')?2:0);
        }
      }

      celldata.push({ r: R, c: C, v });
    }
  }

  // merges
  if (Array.isArray(ws['!merges'])){
    ws['!merges'].forEach(m=>{
      merges.push({ r: m.s.r, c: m.s.c, rs: m.e.r - m.s.r + 1, cs: m.e.c - m.s.c + 1 });
    });
  }

  return {
    name: sheetName || 'Sheet1',
    index: 0,
    status: 1,
    order: 0,
    row: Math.max(maxR + 6, 40),
    column: Math.max(maxC + 6, 12),
    celldata,
    config: { merge: merges.length ? merges : undefined }
  };
}

/* main import handler */
async function importFile(file){
  if (!file) return;
  // ask user to confirm overwrite
  if (!confirm('âš ï¸ ç¡®è®¤ç”¨æ–°æ–‡ä»¶è¦†ç›–å½“å‰è¡¨æ ¼ï¼Ÿï¼ˆå½“å‰æœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ï¼‰')) return;

  setStatus('è§£æä¸­â€¦');
  showToast('æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™â€¦', 2000);

  // Attempt 1: LuckyExcel if available (better at style preservation)
  if (typeof window.LuckyExcel !== 'undefined' && window.LuckyExcel.transformExcelToLucky){
    try {
      // LuckyExcel expects a File object
      window.LuckyExcel.transformExcelToLucky(file, function(exportJson){
        try {
          if (!exportJson || !exportJson.sheets || exportJson.sheets.length === 0){
            throw new Error('LuckyExcel è§£æå‡ºç©º sheet');
          }
          // overwrite: destroy and create with new sheets
          try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
          safeInitLuckysheet(exportJson.sheets);
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(exportJson.sheets)); } catch(e){}
          setStatus('å°±ç»ª');
          showToast('å¯¼å…¥æˆåŠŸï¼ˆä½¿ç”¨ LuckyExcelï¼‰ âœ…');
        } catch(err){
          console.error('LuckyExcel è§£æåå¤„ç†å¤±è´¥', err);
          fallbackToSheetJS(file);
        }
      }, function(err){
        console.warn('LuckyExcel è½¬æ¢å¤±è´¥ï¼Œå›é€€ SheetJS', err);
        fallbackToSheetJS(file);
      });
      return; // wait for callback
    } catch(err){
      console.warn('LuckyExcel è°ƒç”¨å¼‚å¸¸ï¼Œå›é€€ SheetJS', err);
      // proceed to fallback
    }
  }

  // Fallback: SheetJS-based parse
  await fallbackToSheetJS(file);
}

/* fallback parse using SheetJS (guarantees basic data + merges + formulas) */
async function fallbackToSheetJS(file){
  try {
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array', cellStyles:true, cellNF:true });
    const sheets = [];
    for (let i=0;i<wb.SheetNames.length;i++){
      const name = wb.SheetNames[i];
      const ws = wb.Sheets[name];
      const sheet = sheetjs_to_luckysheet(ws, name);
      sheet.index = i;
      sheets.push(sheet);
    }
    // overwrite
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    safeInitLuckysheet(sheets);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(sheets)); } catch(e){}
    setStatus('å°±ç»ª');
    showToast('å¯¼å…¥æˆåŠŸï¼ˆä½¿ç”¨ SheetJS å›é€€è§£æï¼‰ âœ…');
  } catch(err){
    console.error('SheetJS è§£æå¤±è´¥', err);
    // final recovery: empty table (prevent userå¡æ­»)
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    safeInitLuckysheet(null);
    setStatus('å°±ç»ªï¼ˆå·²æ¢å¤ç©ºè¡¨ï¼‰');
    showToast('å¯¼å…¥å¤±è´¥ï¼Œå·²æ¢å¤ç©ºè¡¨ âš ï¸');
  }
}

/* wire file input */
document.getElementById('fileInput').addEventListener('change', function(e){
  const f = e.target.files[0];
  if (!f) return;
  importFile(f);
  // clear input so same file can be reselected later
  e.target.value = '';
});

/* ================ SAVE / EXPORT ================ */

/* convert luckysheet internal -> workbook (SheetJS) */
function luckysheetToWorkbook(){
  const sheets = luckysheet.getAllSheets();
  const wb = XLSX.utils.book_new();

  sheets.forEach(s=>{
    const ws = {};
    let maxR = 0, maxC = 0;
    if (Array.isArray(s.celldata)){
      s.celldata.forEach(cell=>{
        const r = cell.r, c = cell.c;
        maxR = Math.max(maxR, r);
        maxC = Math.max(maxC, c);
        const addr = XLSX.utils.encode_cell({r,c});
        const val = (cell.v && cell.v.v !== undefined) ? cell.v.v : (cell.v ? cell.v : "");
        ws[addr] = { v: val };
        // formula support
        if (cell.v && cell.v.f) ws[addr].f = cell.v.f;
        if (cell.f) ws[addr].f = cell.f;
        // text display
        if (cell.v && cell.v.m !== undefined) ws[addr].w = String(cell.v.m);
        // styles: limited; constructing .s requires SheetJS Pro for full support.
        // We'll attempt basic number -> leave styling to LuckyExcel export when available.
      });
    }
    // merges
    const merges = [];
    if (s.config && s.config.merge && Array.isArray(s.config.merge)){
      s.config.merge.forEach(m=>{
        merges.push({ s:{r:m.r,c:m.c}, e:{r:m.r + (m.rs-1), c:m.c + (m.cs-1)} });
      });
    } else if (s.merge && Array.isArray(s.merge)){
      s.merge.forEach(m=>{
        merges.push({ s:{r:m.r,c:m.c}, e:{r:m.r + (m.rs-1), c:m.c + (m.cs-1)} });
      });
    }
    if (merges.length) ws['!merges'] = merges;

    // range
    const range = { s:{r:0,c:0}, e:{r: Math.max(maxR, (s.row? s.row-1:0)), c: Math.max(maxC, (s.column? s.column-1:0))} };
    ws['!ref'] = XLSX.utils.encode_range(range);

    XLSX.utils.book_append_sheet(wb, ws, s.name || 'Sheet');
  });

  return wb;
}

/* Save button: manual save (download + cache) */
document.getElementById('btnSave').addEventListener('click', async function(){
  setStatus('ä¿å­˜ä¸­â€¦');
  try {
    // get sheets and cache locally
    const sheets = luckysheet.getAllSheets();
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(sheets)); } catch(e){ console.warn('æœ¬åœ°ç¼“å­˜å†™å…¥å¤±è´¥', e); }

    // Prefer LuckyExcel export if available so styles are better preserved
    if (typeof window.LuckyExcel !== 'undefined' && window.LuckyExcel.exportLuckyToExcel){
      try {
        // LuckyExcel expects an object with sheets
        window.LuckyExcel.exportLuckyToExcel({ sheets: sheets }, 'æŠ¥ä»·è¡¨-å¯¼å‡º.xlsx');
        showToast('ä¿å­˜æˆåŠŸï¼ˆå·²ä¸‹è½½ï¼Œä½¿ç”¨ LuckyExcel å¯¼å‡ºï¼‰ âœ…');
        setStatus('å·²ä¿å­˜');
        return;
      } catch(err){
        console.warn('LuckyExcel å¯¼å‡ºå¤±è´¥ï¼Œå›é€€ SheetJS å¯¼å‡º', err);
      }
    }

    // Fallback: use SheetJS workbook creation
    const wb = luckysheetToWorkbook();
    XLSX.writeFile(wb, 'æŠ¥ä»·è¡¨-å¯¼å‡º.xlsx');
    showToast('ä¿å­˜æˆåŠŸï¼ˆå·²ä¸‹è½½ï¼‰ âœ…');
    setStatus('å·²ä¿å­˜');
  } catch(err){
    console.error('ä¿å­˜å¤±è´¥', err);
    showToast('ä¿å­˜å¤±è´¥ âš ï¸');
    setStatus('ä¿å­˜å¤±è´¥');
  }
});

/* ================ EXPORT IMAGE ================ */
document.getElementById('btnExportImage').addEventListener('click', async function(){
  setStatus('å¯¼å‡ºå›¾ç‰‡ä¸­â€¦');
  // Prefer luckysheet.toImage if available
  try {
    if (luckysheet && typeof luckysheet.toImage === 'function') {
      // luckysheet.toImage accepts callback in many builds
      luckysheet.toImage(function(imgData){
        const link = document.createElement('a');
        link.href = imgData;
        link.download = 'æŠ¥ä»·è¡¨.png';
        link.click();
        showToast('å¯¼å‡ºå›¾ç‰‡æˆåŠŸ âœ…');
        setStatus('å°±ç»ª');
      });
      return;
    }
  } catch(e){
    console.warn('luckysheet.toImage ä¸å¯ç”¨ï¼Œå›é€€ html2canvas', e);
  }

  // fallback html2canvas (screenshot of container)
  try {
    const el = document.getElementById('luckysheet');
    const canvas = await html2canvas(el, { scale: 2 });
    canvas.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'æŠ¥ä»·è¡¨.png';
      link.click();
      URL.revokeObjectURL(url);
      showToast('å¯¼å‡ºå›¾ç‰‡æˆåŠŸ âœ…');
      setStatus('å°±ç»ª');
    });
  } catch(err){
    console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥', err);
    showToast('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ âš ï¸');
    setStatus('å¯¼å‡ºå¤±è´¥');
  }
});

/* ================ RESET / RECOVER ================ */
document.getElementById('btnReset').addEventListener('click', function(){
  if (!confirm('ç¡®è®¤æ¢å¤ä¸ºç©ºè¡¨å¹¶åˆ é™¤æœ¬åœ°ç¼“å­˜ï¼Ÿ')) return;
  try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
  safeInitLuckysheet(null);
  showToast('å·²æ¢å¤ç©ºè¡¨');
  setStatus('å°±ç»ª');
});

/* ================ UX: prevent accidental heavy renders ================ */
/* If a very large sheet is loaded, the UI will still try; user can reset. */
/* Additional heuristics could be added (max cells threshold) to refuse huge imports. */

</script>
</body>
</html>
