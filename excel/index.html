<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>网页版报价单</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Luckysheet 样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/css/pluginsCss.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/css/luckysheet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet/dist/assets/iconfont/iconfont.css" />
  <style>
    body,html{margin:0;padding:0;height:100%;width:100%;}
    #toolbar{padding:10px;background:#f0f0f0;text-align:center;}
    #luckysheet{width:100%;height:calc(100% - 60px);}
    button{margin:5px;padding:6px 12px;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
           background:#333;color:#fff;padding:8px 16px;border-radius:4px;display:none;}
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <button onclick="saveSheet()">💾 保存</button>
    <button onclick="exportExcel()">📤 导出Excel</button>
    <button onclick="exportImage()">🖼 导出图片</button>
    <button onclick="clearSheet()">🗑 清空</button>
  </div>
  <div id="luckysheet"></div>
  <div class="toast" id="toast"></div>

  <!-- JS 依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/luckysheet.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>

  <script>
    const STORAGE_KEY = "quoteSheetData";

    // ✅ Toast 提示
    function showToast(msg){
      const t=document.getElementById("toast");
      t.innerText=msg; t.style.display="block";
      setTimeout(()=>{t.style.display="none";},2000);
    }

    // ✅ 彻底销毁 Luckysheet
    function resetLuckysheetDOM(){
      try{luckysheet.destroy();}catch(e){}
      document.getElementById("luckysheet").innerHTML="";
    }

    // ✅ 修复行列数
    function fixSheetSize(sheet){
      let maxR=0,maxC=0;
      if(sheet.celldata){
        sheet.celldata.forEach(cell=>{
          if(cell.r>maxR) maxR=cell.r;
          if(cell.c>maxC) maxC=cell.c;
        });
      }
      sheet.row=Math.max(sheet.row||0,maxR+20);
      sheet.column=Math.max(sheet.column||0,maxC+10);
      if(!sheet.config) sheet.config={};
      return sheet;
    }

    // ✅ 过滤非法单元格
    function sanitizeCelldata(sheet){
      if(!sheet.celldata) return sheet;
      sheet.celldata=sheet.celldata.filter(cell=>{
        return cell && typeof cell.r==="number" && typeof cell.c==="number" && cell.v;
      });
      return sheet;
    }

    // ✅ 初始化 Luckysheet
    function initLuckysheet(data){
      resetLuckysheetDOM();
      try{
        luckysheet.create({
          container:'luckysheet',
          showinfobar:false,
          lang:'zh',
          data:data || [{
            name:"报价单", index:0, status:1, order:0,
            row:40, column:12, celldata:[], config:{}
          }],
          showsheetbar:true,
          showtoolbar:true,
          forceCalculation:false
        });
      }catch(err){
        console.error("渲染错误:",err);
        showToast("⚠️ 表格渲染失败，已恢复为空表");
        resetLuckysheetDOM();
        luckysheet.create({container:'luckysheet',data:[{name:"空表",index:0,row:40,column:12,celldata:[]} ]});
      }
    }

    // ✅ 导入文件
    document.getElementById("fileInput").addEventListener("change",function(e){
      const file=e.target.files[0];
      if(!file) return;
      LuckyExcel.transformExcelToLucky(file,(exportJson)=>{
        if(!exportJson.sheets || exportJson.sheets.length===0){
          showToast("⚠️ 无法解析文件");
          return;
        }
        let sheets=exportJson.sheets.map(s=>sanitizeCelldata(fixSheetSize(s)));
        localStorage.setItem(STORAGE_KEY,JSON.stringify(sheets));
        initLuckysheet(sheets);
        showToast("✅ 导入成功");
      });
    });

    // ✅ 保存
    function saveSheet(){
      const data=luckysheet.getAllSheets();
      localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
      // 同时下载 Excel 文件
      luckysheet.exportExcel().then(excelFile=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(excelFile);
        a.download="报价单.xlsx";
        a.click();
      });
      showToast("✅ 已保存");
    }

    // ✅ 导出 Excel
    function exportExcel(){
      luckysheet.exportExcel().then(excelFile=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(excelFile);
        a.download="报价单.xlsx";
        a.click();
      });
      showToast("📤 已导出Excel");
    }

    // ✅ 导出图片
    function exportImage(){
      luckysheet.toJson().then(blob=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="报价单.png";
        a.click();
      });
      showToast("🖼 已导出图片");
    }

    // ✅ 清空
    function clearSheet(){
      if(confirm("⚠️ 确认清空当前表格吗？")){
        localStorage.removeItem(STORAGE_KEY);
        initLuckysheet(null);
        showToast("🗑 已清空");
      }
    }

    // ✅ 页面加载时恢复
    window.onload=function(){
      let saved=localStorage.getItem(STORAGE_KEY);
      if(saved){
        try{
          initLuckysheet(JSON.parse(saved));
        }catch(e){
          console.warn("缓存损坏，恢复空表");
          initLuckysheet(null);
        }
      }else{
        initLuckysheet(null);
      }
    }
  </script>
</body>
</html>
